{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../modules/component/migrations/15_0_0-beta/index.ts"],"names":[],"mappings":"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","sourcesContent":["import * as ts from 'typescript';\nimport { Rule, chain, Tree } from '@angular-devkit/schematics';\nimport {\n  visitTSSourceFiles,\n  commitChanges,\n  createReplaceChange,\n  ReplaceChange,\n} from '../../schematics-core';\n\nconst reactiveComponentModuleText = 'ReactiveComponentModule';\nconst reactiveComponentModuleReplacement = 'LetModule, PushModule';\nconst moduleLocations = {\n  imports: ['NgModule', 'Component'],\n  exports: ['NgModule'],\n};\n\nfunction migrateReactiveComponentModule() {\n  return (tree: Tree) => {\n    visitTSSourceFiles(tree, (sourceFile) => {\n      const componentImports = sourceFile.statements\n        .filter(ts.isImportDeclaration)\n        .filter(({ moduleSpecifier }) =>\n          moduleSpecifier.getText(sourceFile).includes('@ngrx/component')\n        );\n\n      if (componentImports.length === 0) {\n        return;\n      }\n\n      const ngModuleReplacements =\n        findReactiveComponentModuleNgModuleReplacements(sourceFile);\n\n      const possibleUsagesOfReactiveComponentModuleCount =\n        findPossibleReactiveComponentModuleUsageCount(sourceFile);\n\n      const importAdditionReplacements =\n        findReactiveComponentModuleImportDeclarationAdditions(\n          sourceFile,\n          componentImports\n        );\n\n      const importUsagesCount = importAdditionReplacements.length;\n\n      const jsImportDeclarationReplacements =\n        possibleUsagesOfReactiveComponentModuleCount >\n        ngModuleReplacements.length + importUsagesCount\n          ? importAdditionReplacements\n          : findReactiveComponentModuleImportDeclarationReplacements(\n              sourceFile,\n              componentImports\n            );\n\n      const changes = [\n        ...jsImportDeclarationReplacements,\n        ...ngModuleReplacements,\n      ];\n\n      commitChanges(tree, sourceFile.fileName, changes);\n    });\n  };\n}\n\nfunction findReactiveComponentModuleImportDeclarationReplacements(\n  sourceFile: ts.SourceFile,\n  imports: ts.ImportDeclaration[]\n) {\n  const changes = imports\n    .map((p) => (p?.importClause?.namedBindings as ts.NamedImports)?.elements)\n    .reduce(\n      (imports, curr) => imports.concat(curr ?? []),\n      [] as ts.ImportSpecifier[]\n    )\n    .map((specifier) => {\n      if (!ts.isImportSpecifier(specifier)) {\n        return { hit: false };\n      }\n\n      if (specifier.name.text === reactiveComponentModuleText) {\n        return { hit: true, specifier, text: specifier.name.text };\n      }\n\n      // if import is renamed\n      if (\n        specifier.propertyName &&\n        specifier.propertyName.text === reactiveComponentModuleText\n      ) {\n        return { hit: true, specifier, text: specifier.propertyName.text };\n      }\n\n      return { hit: false };\n    })\n    .filter(({ hit }) => hit)\n    .map(({ specifier, text }) =>\n      !!specifier && !!text\n        ? createReplaceChange(\n            sourceFile,\n            specifier,\n            text,\n            reactiveComponentModuleReplacement\n          )\n        : undefined\n    )\n    .filter((change) => !!change) as Array<ReplaceChange>;\n\n  return changes;\n}\n\nfunction findReactiveComponentModuleImportDeclarationAdditions(\n  sourceFile: ts.SourceFile,\n  imports: ts.ImportDeclaration[]\n) {\n  const changes = imports\n    .map((p) => (p?.importClause?.namedBindings as ts.NamedImports)?.elements)\n    .reduce(\n      (imports, curr) => imports.concat(curr ?? []),\n      [] as ts.ImportSpecifier[]\n    )\n    .map((specifier) => {\n      if (!ts.isImportSpecifier(specifier)) {\n        return { hit: false };\n      }\n\n      if (specifier.name.text === reactiveComponentModuleText) {\n        return { hit: true, specifier, text: specifier.name.text };\n      }\n\n      // if import is renamed\n      if (\n        specifier.propertyName &&\n        specifier.propertyName.text === reactiveComponentModuleText\n      ) {\n        return { hit: true, specifier, text: specifier.propertyName.text };\n      }\n\n      return { hit: false };\n    })\n    .filter(({ hit }) => hit)\n    .map(({ specifier, text }) =>\n      !!specifier && !!text\n        ? createReplaceChange(\n            sourceFile,\n            specifier,\n            text,\n            `${text}, ${reactiveComponentModuleReplacement}`\n          )\n        : undefined\n    )\n    .filter((change) => !!change) as Array<ReplaceChange>;\n\n  return changes;\n}\n\nfunction findPossibleReactiveComponentModuleUsageCount(\n  sourceFile: ts.SourceFile\n): number {\n  let count = 0;\n  ts.forEachChild(sourceFile, (node) => countUsages(node));\n  return count;\n\n  function countUsages(node: ts.Node) {\n    if (ts.isIdentifier(node) && node.text === reactiveComponentModuleText) {\n      count = count + 1;\n    }\n\n    ts.forEachChild(node, (childNode) => countUsages(childNode));\n  }\n}\n\nfunction findReactiveComponentModuleNgModuleReplacements(\n  sourceFile: ts.SourceFile\n) {\n  const changes: ReplaceChange[] = [];\n  ts.forEachChild(sourceFile, (node) => find(node, changes));\n  return changes;\n\n  function find(node: ts.Node, changes: ReplaceChange[]) {\n    let change = undefined;\n\n    if (\n      ts.isIdentifier(node) &&\n      node.text === reactiveComponentModuleText &&\n      ts.isArrayLiteralExpression(node.parent) &&\n      ts.isPropertyAssignment(node.parent.parent)\n    ) {\n      const property = node.parent.parent;\n      if (ts.isIdentifier(property.name)) {\n        const propertyName = String(property.name.escapedText);\n        if (Object.keys(moduleLocations).includes(propertyName)) {\n          const decorator = property.parent.parent.parent;\n          if (\n            ts.isDecorator(decorator) &&\n            ts.isCallExpression(decorator.expression) &&\n            ts.isIdentifier(decorator.expression.expression) &&\n            moduleLocations[propertyName as 'imports' | 'exports'].includes(\n              String(decorator.expression.expression.escapedText)\n            )\n          ) {\n            change = {\n              node: node,\n              text: node.text,\n            };\n          }\n        }\n      }\n    }\n\n    if (change) {\n      changes.push(\n        createReplaceChange(\n          sourceFile,\n          change.node,\n          change.text,\n          reactiveComponentModuleReplacement\n        )\n      );\n    }\n\n    ts.forEachChild(node, (childNode) => find(childNode, changes));\n  }\n}\n\nexport default function (): Rule {\n  return chain([migrateReactiveComponentModule()]);\n}\n"]}